## 1. 偏好匹配
### 1.1. 匹配问题
一个匹配问题给出如下
1. 自然数$n$表示人群中买家和卖家的数量(这里我们假设买家和卖家数量相同)
2. 每个买家在卖家的集合上有一个偏好关系
3. 每个卖家在买家的集合上有一个偏好关系

我们将买家的集合表示为$B$, 集合中的一个元素表示为$b$. 将卖家的集合表示为$S$, 集合中的一个元素表示为$s$. 

匹配就是一个从买家到卖家的双射, 表示为$M$, 用$b^M$表示$s$在$M$中的匹配对象, 用$s^M$表示$b$在$M$中的匹配对象. 

### 1.2. 稳定匹配
一个卖家和一个买家反对一个匹配, 如果他们认为对方优于自己在匹配下被配给的对象. 一个匹配是稳定的, 如果不存在反对这个匹配的卖家和买家. 

也就是说, 对于任意$b_i, s_j$, 如果
$$
b_i \succ_{s_j} b_j^M \quad \text{and} \quad s_j \succ_{b_i} s_i^M
$$
那么我们说$s_j$和$b_i$反对$M$.

### 1.3. 稳定匹配的存在性(买家搜寻算法)
考虑如下的算法
1. 每个买家站在他最倾向的卖家面前, 每个卖家从站在他面前的买家中选择一个最喜欢的让他留下, 让其他的都离开.
2. 在第一阶段被被卖家拒绝的每个买家, 从没有拒绝他的卖家中选择一个最倾向的, 然后站在他面前. 每个卖家从站在他面前的买家中选择一个最喜欢的让他留下, 让其他的都离开. 
3. 重复第二阶段, 直到每个买家都被一个卖家接受.

这个算法可以得到一个稳定的匹配. 我们将这个算法记为$O^b$
___
##### Proof
首先证明存在一个阶段, 没有买家被拒绝. 这是因为每个卖家最多拒绝$n-1$个买家, 因此最多经过$n(n-1)+1$个阶段, 就不再有拒绝发生.

接下来, 我们证明一个买家不可能被所有卖家拒绝. 用反证法, 假设有一个买家$b$被所有的卖家拒绝了. 根据这个算法的构建, $b$一定光顾了每个卖家. 当$b$光顾某个卖家$s$之后, $s$就一定始终被某个买家光顾. 但买家和卖家的人数是相等的, 这就得到了矛盾! 因此, 买家搜寻算法一定能够得到一个匹配. 

最后, 证明这个匹配是稳定的. 用反证法, 如果匹配不是稳定的, 不妨设$b_i$和$s_j$反对这个匹配. 但是因为买家是按照偏好顺序访问卖家的, 因此$b_i$在光顾$s_i^M$之前一定光顾过$s_j$, 再根据算法, $s_j$的匹配$b_j^M$一定比$b_i$更好, 这与$b_i$和$s_j$反对这个匹配矛盾! 因此, 这个匹配是稳定的.
#####
___

### 1.4. 稳定匹配的存在性(卖家搜寻算法)
考虑如下的算法
1. 每个卖家站在他最倾向的买家面前, 每个买家从站在他面前的卖家中选择一个最喜欢的让他留下, 让其他的都离开.
2. 在第一阶段被被买家拒绝的每个卖家, 从没有拒绝他的买家中选择一个最倾向的, 然后站在他面前. 每个买家从站在他面前的卖家中选择一个最喜欢的让他留下, 让其他的都离开. 
3. 重复第二阶段, 直到每个卖家都被一个买家接受.

这个算法可以得到一个稳定的匹配. 我们将这个算法记为$O^s$


## 2. 偏好匹配的比较
### 2.1. 匹配上的顺序关系
令$A$和$B$是两个匹配. 如果对于任意的$b_i$, 都有$s_i^A\succsim_{b_i} s_i^B$, 那么$A\succsim^b B$. 如果对于任意的$s_i$, 都有$b_i^A\succsim_{s_i} b_i^B$, 那么$A\succsim^s B$. 

显然, $\succsim^b$ 和 $\succsim^s$都满足自反性和传递性. 

### 2.2. 匹配的顺序关系
对每一对稳定均衡$A$和$B$, $A\succsim^b B$当且仅当$B\succsim^s A$. 
___
##### Proof
我们将证明如果$A\succsim^b B$, 那么$B\succsim^s A$. 反方向的结论可以通过对称性得到. 

考虑任意的卖家$s$, 他在$A$下匹配到的买家是$b_1$, 在$A$下匹配到的买家是$b_2$. 显然, 我们有
$$
s = s_1^A\succsim_{b_1} s_1^B
$$
因为$B$是一个稳定的匹配, 所以$s$和$b_1$没有动机反对
$$
s \succsim_{b_1} s_1^B \implies b_2 \succsim_{s} b_1
$$
这就证明了$B\succsim^s A$
#####
___

### 2.3. 最优匹配和最劣匹配
对每个稳定匹配$A$, 我们有
$$
O^b \succsim^b A \succsim^b O^s, \quad O^s \succsim^s A \succsim^s O^b
$$
___
##### Proof
我们只要证明$O^b \succsim^b A$对每个稳定匹配$A$成立. 我们说一个卖家$s$对于一个买家$b$而言是可能的, 如果存在一个稳定匹配, 使得他们彼此配对. 

我们首先证明, 在买家搜寻算法中, 拒绝了某个买家$b$的每个卖家$s$, 对于买家$b$都是不可能的. 假设买家在第$k$阶段被拒绝, 当$k=1$时, 显然成立. 当$k\ge 2$时, 根据归纳假设, 在算法的前$k-1$个阶段拒绝了买家$b$的某个卖家, 对买家$b$都是不可能的. 设$b$在算法的第$k$阶段被$s$拒绝. 而$b_0\succ_{s} b$是第$k$阶段被$s$留下的买家. 用反证法, 假设$s$对$b$是可能的, 也就是说, 存在某个匹配$A$, 使得$b$和$s$是匹配的. 考虑$s_0^A$是$b_0$在匹配$A$下匹配的卖家. 因为$s_0^A$对$b_0$是可能的, 因此$s_0^A$不可能在算法的前$k-1$阶段拒绝了$b_0$, 这意味着$s\succ_{b_0} s_0^A$. 于是$s$和$b_0$反对匹配$A$, 因此$A$是不稳定的. 

根据上面的结果, 我们很自然地可以证明$O^b \succsim^b A$
#####
___


### 2.4. 格子结构
令$X$是一个有限集合, $\succsim$是$X$上的一个部分排序, $x_1, x_2\in X$是$X$内的两个元素, 元素$y\in X$叫作$x_1, x_2$的最大值, 记作$y=\max\{x_1, x_2\}$, 如果
1. $y\succsim x_1$并且$y\succsim x_2$
2. 如果$z\succsim x_1$并且$z\succsim x_2$, 那么$z\succsim y$

同样地, 可以定义最小值, 记作$y= \min\{x_1, x_2\}$.
1. $x_1\succsim y$并且$x_2\succsim y$
2. 如果$x_1\succsim z$并且$x_2\succsim z$, 那么$y\succsim z$

一个格子是一个部分排序集, 如果集合中的任意一对元素都有最大值和最小值. 

### 2.5. 稳定匹配的最大最小值
对于稳定匹配集上的部分排序$\succsim^b$, 我们有
$$
\begin{aligned} 
\max\{A, B\} &= A \vee^b B = \{(b_1, s_1), (b_2, s_2), \cdots (b_n, s_n)\mid s_i = \max\limits_{\succsim_{b_i}}\{s_i^A, s_i^B\} \}\\ 
\min\{A, B\} &= A \vee^s B = \{(b_1, s_1), (b_2, s_2), \cdots (b_n, s_n)\mid b_i = \max\limits_{\succsim_{s_i}}\{b_i^A, b_i^B\} \}
\end{aligned}
$$
其中, $A \vee^b B$和$A \vee^s B$是良定义的. 因此, 在部分排序$\succsim^b$下, 稳定匹配集是一个格子.
___
##### Proof
我们只要证明$A \vee^b B$和$A \vee^s B$是稳定匹配. 由于这两者是对称的, 因此我们只要证明$A \vee^b B$是稳定匹配.

首先, 我们证明$C = A \vee^b B$是一个匹配, 根据反证法, 假设$C$不是一个匹配. 也就是说, 存在某个买家$b$在$C$中被两个卖家$s_1, s_2$选中. 不妨设$b_1^A = b = b_2^B$
$$
b\succ_{s_1} b_1^B, \quad b\succ_{s_2} b_2^A 
$$
如果$s_1\succ_{b} s_2$, 那么$B$是不稳定的, 因为$b$和$s_1$反对$B$. 如果$s_2\succ_{b} s_1$, 那么$AB$是不稳定的, 因为$b$和$s_2$反对$A$. 矛盾! 因此, $C$是一个匹配.

接下来, 我们证明$C$是一个稳定匹配. 仍然使用反证法, 假设$C$是不稳定的. 那么存在某个买家$b$和卖家$s$, 使得
$$
b\succ_{s} b^C, \quad s\succ_{b} s^C
$$
因为在匹配$C$下, $b$被匹配给了$s^C$, 因此其在$A$或者$B$中一定也匹配了$s^C$, 不妨设$s^A = s^C\neq s^B$, 那么
$$
s\succ_{b} s^C \succ_{b} s^B
$$ 
因为$A$是一个稳定匹配, $b$和$s$都无异议, 因此
$$
s\succ_{b} s^C \implies b^A\succ_{s} b \implies b^C\neq b^A
$$
因为$B$是一个稳定匹配, $b$和$s$都无异议, 因此
$$
s\succ_{b} s^B \implies b^B\succ_{s} b \implies b^C\neq b^B
$$
这样, 我们证明了在$A$和$B$下, $b^C$都没有被匹配给$s$, 因此在$C$下, $b^C$当然也没有被匹配给$s$, 矛盾! 因此, $C$是一个稳定匹配.
#####
___


## 3. 其他偏好匹配问题
### 3.1. 买家和卖家人数不相等的匹配
#### 3.1.1. 定义
不妨设买家人数多于卖家人数. 一个匹配是一个函数, 这个函数将每个买家和集合$S\cup\{\mathrm{None}\}$中的元素联系起来, 使得每个卖家都被匹配到一个买家. 

给定一个匹配$M$, 一个买家$b$和一个卖家$s$反对匹配, 条件是
1. 买家$b$和None匹配, 或者他认为$s\succ_{b} s^M$
2. $b\succ_{s} b^M$

如果一个匹配没有被任何买家和卖家反对, 那么这个匹配是稳定的.


#### 3.1.2. 买家搜寻算法
考虑如下的算法

1. 每个买家站在他最倾向的卖家面前, 每个卖家从站在他面前的买家中选择一个最喜欢的让他留下, 让其他的都离开.
2. 在第一阶段被被卖家拒绝的每个买家, 从没有拒绝他的卖家中选择一个最倾向的, 然后站在他面前. 每个卖家从站在他面前的买家中选择一个最喜欢的让他留下, 让其他的都离开. 
3. 重复第二阶段, 直到每个卖家的面前都只有一个买家. 

这个算法可以得到一个稳定的匹配.

#### 3.1.3. None集的一致性
不妨设买家人数多于卖家人数. 如果某个特定的买家$b$在一些稳定匹配下没有和任何卖家匹配. 那么在所有的稳定匹配下, $b$都没有和任何卖家匹配.
___
##### Proof
用反证法, 假设$b_0$在稳定匹配$A$下没有和任何卖家匹配, 但是在稳定匹配$B$下和卖家$s_0$匹配. 构造一个二部图, 左边是买家节点, 右边是卖家节点. 将$A$中匹配的边染成红色, 将$B$中匹配的边染成蓝色. 从节点None出发, 第一条边选择$\mathrm{None}\mapsto b_0$的红边, 第二条边选择$b_0\mapsto s_0$的蓝边, 红蓝交替地搜寻一条道路, 设道路中经过的节点分别是
$$
b_0, s_0, b_1, s_2,\cdots , b_k, s_k=\mathrm{None}
$$ 
其中$k$是最小的使得$s_k=\mathrm{None}$的正整数. 如果$b_1\succ_{s_0} b_0$, 根据$A$, $B$都是稳定匹配, 我们有
$$
s_1 \succ_{b_1} s_0, \quad b_2 \succ_{s_1} b_1, \quad s_2 \succ_{b_2} s_1, \quad \cdots, \quad b_k \succ_{s_{k-1}} b_{k-1}
$$
考虑匹配$B$中的节点$s_{k-1}$和$b_k$, 他们反对匹配$B$, 因此$B$不是稳定匹配. 矛盾! 如果$b_0\succ_{s_0} b_1$, 在$A$中考虑节点$b_0$和$s_0$, 他们反对匹配$A$, 因此$A$不是稳定匹配, 矛盾!

综上所述, 在所有的稳定匹配下, $b$都没有和任何卖家匹配.
#####
___


### 3.2. None更优的匹配
#### 3.2.1. 定义
一个匹配问题定义为
1. 买家集合$B$和卖家集合$S$
2. 对每个卖家$s$, 其偏好关系定义在集合$B\cup\{\mathrm{None}\}$上
3. 对每个买家$b$, 其偏好关系定义在集合$S\cup\{\mathrm{None}\}$上

给定一个匹配$M$
1. 一个买家$b$反对一个匹配$M$, 如果$\mathrm{None}\succ_{b} s^M$
2. 一个卖家$s$反对一个匹配$M$, 如果$\mathrm{None}\succ_{s} b^M$
3. 一个买家$b$和一个卖家$s$反对一个匹配$M$, 如果
   $$
   s \succ_{b} s^M \quad \text{and} \quad b \succ_{s} b^M
   $$

一个匹配是稳定的, 如果没有买家, 没有卖家, 也没有买家和卖家组合反对这个匹配.

#### 3.2.2. 买家搜寻算法
首先扩展买家集合和卖家集合的定义, 定义买家集合为$B\cup\{s-\mathrm{None}\mid s\in S\}$, 定义卖家集合为$S\cup\{b-\mathrm{None}\mid b\in B\}$. 考虑下面的算法

1. 每个买家站在他最倾向的卖家面前, 每个卖家从站在他面前的买家中选择一个最喜欢的让他留下, 让其他的都离开.
2. 在第一阶段被被卖家拒绝的每个买家, 从没有拒绝他的卖家中选择一个最倾向的, 然后站在他面前. 每个卖家从站在他面前的买家中选择一个最喜欢的让他留下, 让其他的都离开. 
3. 重复第二阶段, 直到每个卖家的面前至多只有一个买家. 

这个算法可以得到一个稳定的匹配.

### 3.3. 一对多匹配
#### 3.3.1. 定义
一对多匹配的问题如下
1. 有限的大学集合$U$和有限的学生集合$S$
2. 对于每个大学$u\in U$, 配额$q_u\in \mathbb{N}$表示大学$u$最多可以接受的学生人数
3. 对每个学生$s\in S$, 他的偏好关系定义在集合$U$上
4. 对每个大学$u\in U$, 他的偏好关系定义在集合$S$上

匹配是一个函数, 这个函数将一个包含$0$到$q_u$个学生的子集$S$赋予每个大学$u\in U$, 使得$S$中的每个学生最多和一个大学相联系. 如果
1. $u \succ_{s} u^M$
2. 大学$u$被配给的学生少于$q_u$个; 或者大学$u$认为$s$优于所匹配的学生中最差的那个. 

那么就称大学$u$和学生$s$对匹配$M$提出异议.

一个匹配是稳定的, 如果所有大学和学生的组合对这个匹配没有异议.


#### 3.3.2. 学生搜寻算法
考虑如下的算法
1. 每个学生站在他最倾向的大学面前, 每个大学$u$从站在他面前的学生中选择最喜欢的$q_u$个让他们留下, 让其他的都离开.
2. 在第一阶段被被大学拒绝的每个学生, 从没有拒绝他的大学中选择一个最倾向的, 然后站在他面前. 每个大学从站在他面前的学生中选择最喜欢的$q_u$个让他们留下, 让其他的都离开. 
3. 重复第二阶段, 直到每个大学面前都至多有$q_u$个学生.

这个算法可以得到一个稳定的匹配. 

### 3.4. 单一性别匹配
单一性别匹配不一定存在稳定匹配. 例如下面的例子, 4个人要分成两组
|  | 1 | 2 | 3 |
| :---: | :---: | :---: | :---: |
| Alex: | Benjamin | Chris | Franklin |
| Benjamin: | Chris | Alex | Franklin |
| Chris: | Alex | Benjamin | Franklin |
| Franklin: | Alex | Chris | Benjamin |

在这个例子中, 不存在任何稳定的匹配. 


## 4. 以金钱为媒介的匹配
### 4.1. 完美匹配与受限组
称一个匹配为一个完美匹配, 如果
1. 二部图的两边有数目相同的节点, 每个节点都有边连接到另一边的节点. 
2. 每个顶点的度均为$1$

一个完美匹配就是二部图中的一组边, 图中的每一个节点恰好是一条边的端点. 

取二部图右侧的任意一组节点$S$, 将二部图左侧与其相连的节点称为$S$的邻居, 用$N(S)$表示. 如果$|S|>|N(S)|$, 则称$S$是一个受限组.

### 4.2. 匹配定理
如果一个两边节点个数相等的二部图无法形成完美匹配, 那么它一定含有一个受限组. 
___
##### Proof
1. 在二部图中, 对于一个匹配, 如果存在一条其两个端点都是非匹配节点的交替通路(匹配和不匹配交替). 则可以利用这个交替通路放大匹配. 基于这一点, 我们称带有非匹配端点的交替通路为增强通路(augmenting path). 
2. 对二部图使用交替宽度优先搜索(alternating BFS). 交替BFS的工作方式如下, 从右边的任意一个非匹配的节点开始, 然后, 进行宽度优先搜索(对于偶数层, 只搜索非匹配边, 对于奇数层, 只搜索匹配边), 如果这种宽度优先搜索过程中一旦产生了一个层次, 其中包含了一个来自图左边的非匹配节点, 我们就发现了一条增强通路. 
3. 如果在搜索结束时, 没有发现任何一个增强通路. 这意味着在奇数层中没有找到任何一个非匹配节点, 因此在每一个奇数层, 节点都通过它们的匹配边连接到下一层的不同节点. 这样, 算上第一层中的节点$W$, 偶数层的节点比奇数层的节点恰好多$1$. 不难验证, 所有偶数层的节点恰好形成了一个限制组.
   
   ![image-1](Lecture%2014.%20%E7%A8%B3%E5%AE%9A%E5%8C%B9%E9%85%8D.assets/%E5%8C%B9%E9%85%8D%E5%AE%9A%E7%90%86%E5%A2%9E%E5%BC%BA%E9%80%9A%E8%B7%AF.png)  


因此对于任何指明了一个匹配的二部图, 设$W$是右边的任何未匹配节点, 如果不存在一个从$W$开始的增强通路, 则存在一个包含了$W$的限制组. 这就证明了匹配定理. 
#####
___


### 4.3. 市场清仓价格
如果卖家把价格设定合适, 那么在人们追逐自我利益(自我利益$=$估值$-$价格)的过程中, 所有买家都不会阻碍别的买家而分别购买到不同的商品. 我们把这组价格称为市场清仓价格.

给定买家的估值和卖家的价格, 我们可以构造如下图所示的偏好卖家图. 


![image-2](Lecture%2014.%20%E7%A8%B3%E5%AE%9A%E5%8C%B9%E9%85%8D.assets/%E5%B8%82%E5%9C%BA%E6%B8%85%E4%BB%93%E4%BB%B7%E6%A0%BC.png)  



### 4.4. 整数价格市场清仓价格的构造
1. **初始化**: 所有卖家都把价格设置为$0$, 买家通过选择他们的偏好卖家做出反应. 如果偏好卖家图中含有完美匹配, 则得到了一个市场清仓价格.
2. **迭代**: 如果偏好卖家图的完美匹配不存在, 则存在一个受限组$S$和他们的邻居$N(S)$. $N(S)$中的每个卖家同时把出价提高一个单位. 与此同时, 统一约减卖家价格, 使得最低价格为$0$, 用新的价格构建偏好卖家图. 

经过有限步的迭代, 一定可以得到一组市场清仓价格. 
___
##### Proof
对于任何当前价格集合, 定义一个买家的势能(potential of a buyer)是他当前可能获得的最大回报. 定义一个卖家的是能(potential of a seller)为他当前给出的价格. 定义拍卖的势能为所有参与者的势能之和, 包括买家和卖家. 

开始, 所有卖家的势能都为$0$, 每个买家的势能等于其最大估值. 于是, 开始时拍卖的势能就是某个整数$P_0\ge 0$. 在之后的每一轮中, 只能始终大于等于$0$. 对于$N(S)$中的每个卖家, 他们的势能增加了$1$, 但$S$中的每个买家他们的势能减少了$1$, 由于$|S|>|N(S)|$, 因此拍卖的势能总和下降的比上升的多. 因此, 拍卖的势能在每一轮中都会减少. 由于拍卖的势能是一个非负整数, 因此经过有限步迭代, 一定可以得到一组市场清仓价格. 
#####
___
